'use strict'

const expect = require('chai').expect

let fs = require('fs'),
	corebio = require('core-bio'),
	fastaUtils = require('./fasta-utils.js')

describe('fasta-utils', function() {
	describe('loadFasta', function() {
		it('It loads fasta file into an array', function() {
			let sampleFile = './sampleData/fasta_sample.10.fa'
			let expected = [
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Bu_pse_2959|BURPS305_6088|ZP_01764768.1',
					sequence_: 'MSTDDDFGRASLLELFREETHTQTQALSERLLALERGAQDAATLEACMRAAHSLKGAARIVGVPQGVDIAGRMEDCFVAAQHGRQPLTPCHVDALLTGVDLLVRVGDPQTAASVAPHEIDAFAAALAAADAGVEPGADARGANAYESDGNAHERGGAARASVAAAPGEAADASRESGAREAAGPNRAGAAAGAADVRASADAGDARGASDTRDVRHTAGARGANRSTEVFGAGEATGIGASTHANDANGMNATNLATSAAHPPRGAFAAAHDAPPSSAPSDAPRAPSQMRRVRADTLNRLLSLSGESLVESRWLKPFAESMLRVKRAQRDAARSLDSAVEALADDADPRVRGALNEARQMFTDLQRTFAARLDELDRFERRSSHIAEQLYDEALQCRMRPFGDATRAYPRVVRDLARSLGKRVRFSIVGEATQVDRDILDMLDAPLGHLLRNALDHGVEPPEVRLARGKPAEAAITLEARHSAGSLLVSVSDDGPGADLAAVRAAIVRHHLTDEDTAARLSDQELLEFLLLPGFSMRERVTDVSGRGVGLDAVQEMVKSVRGAVRIFNEPGLGMRFVLQLPLTLSVIRSLIVDVGGEPYAFPLVQVRRTLELERADIDVLEGQQHFPLDDRRVGLVTAHQLLDAGELDESRPATAVVVVGGEPETYGVAVDRFLGERMLVVQPLDGRLNKIQNIAAGALLENGDPVLIVDVEDLIRSIDKLIRGGQLAKVRRGDRDALARRAKRVLVVDDSLTVRELERKLLEKRGYDVTIAIDGMDGWNAIRGDAFDLVVTDIDMPRMDGIELVTLIKGDPLLKSVPVMIVSYKDRDEDRRRGLEAGADYYLAKGGFHDEALLDAVHDLIGDA'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Al_den_1386|Alide2_3888|YP_004389725.1',
					sequence_: 'MSSLDAVITPGADGAQNEQDLGPLAWVLDELRKSLDSAVKAMRRFVRDAEIARESDLAALDAGPLRIARQQLHQASGALEMVGMAPPALLLRAMESAVQRFVQRPELCSDEAAATIERASFALIEYLECVLAGKAVSPVALFPQYRDSQALAGADRVHPADLWPVERRPREIELAAGVAEPLAYGPEARARLDSAVLRIVKNADPAAAADMRTVCQGFAAAQSKPEVRAFWGICAGFFEALAQGALKPDVYAKRVASRVLMQYATLAKGDDGIGERLVQDLLFFCAQAAADAARMPALQAVREAFGLQGHRPVDYDQPRFGRFDPAVLAQARKRIAAATETWSALAGGDRNKLKPAADQFSLVCDSLRKLHPDSDSLAQSLTRAMDATLRSGEPPSAALAMEVATAVLYLQASLEELDGAGDAMAQRATRLAERLDGVVAGGESQPLEPWMEELYRRVSDHQTMGSVVGELRATLSEAEKSMDQYFRQLENPEVLRSVPGSLQQMRGVLSVLGLDQASLAVVRMRDMVERLLIDAVAEGERQQVFEKLGNSMGALGFLVDMLSYQRAMARKLFVYDEELGELRILMGRVRAPEAAGAEGQAEPPLADLASPEAEAGVQAVELPPEPAVPEPPAAPALELPTPAAASAPVASDADDGQELLDIFLEEAREVVAAGQAAIDALHAEPGDLSEQTTLRRAFHTLKGSSRMVGLSEFGEAAWSMEQVLNAWLAEQKPMQAPLLQLSADALQAFARWADDIAAGTADHWQVQAFRAAADAMRQDGTLVPLAAPTAAQPLAEEEAGVAPDAPIDAAMPGELPREQPPAAAGPQAIAQAPEDAAISSFDLLLPDAEDAPQQDFADTCIDAYDPGRDAQAPAPAPDLAEEVDFALFEQAMQVGADVQESPAQEPAGVAAEEALADDQPQAPPAHAFDIEQAEAAPIAEPDEPAAEPAFEPSPAWADAAGSVEPDVPSPADEAVKVIEHLRIGIPLYNVYLNEADEWSRRLCTSLQEWSLELHQPLPDTAVALAHSLAGSSATVGFTALSGMARTLEHALQHVQLLPHGLPEHAQVFNAAADDIRRLLHQFAAGFLKEPNALVLERLQALLLIEVSSSGRVPLEESAGEEADAGTAAEQGALGSILERELQVDEAIARAVAASVDIDDDIDALDIIDPDLFPIFEEEALELLPALGTALRQWSARPENLGARNELLRALHTLKGSARLAGAMRLGELAHRMETAVEQIGADGVTAADIEPLLSSFDALQAGFDALRTIGAQPLPGPVTVEPPPAAPAASTAAAPAAAAPGQGRAPVAAPLAWAAPAGSSPMPPRVAGGQSVRVRAQLLDRLVNQAGEVVIARSRLDARMSQMRASLGDLTDNLERLRQQLRDIEVQAESQMQSRLALSKDSAAGFDPLEFDRFTRVQELTRMMAESVNDVATVQRNMQRALEGAEDDLVAQGRQARELQRDLLHTRMVEFEGISERLYAVVRQVSKETGKQIKLDISGGSIEMDRGVLDRMTPAFEHLLRNCAGHGIEAPEVRTAAGKPAVGTITIALRHEGNDVSVEFRDDGAGLDIARIRAKAVAQGLAPADAQLSDAEAANLIFLPGLSTATEVTGLSGRGIGMDVVRSEVHALGGRIETWTEAGKGSAFRMVLPLTTAVTQVVMLRAGGLTLGVPASLVEIVRRGSAAELEAAYATHAFSDGQENLPFYWAGALLQSSACSTEAAGKYRPVLILRSAAQRIAVHVDEVLGNQEVVVKNLGPQLSRLPGLTGMSVLASGAVVLIYNPVALATVYGDQARAAMRAPAAVQPEAGVPAQAPAAQDHQVPLVLVVDDSITVRRVTQRLLQREGYRVALAADGLQALERLQQERPAVVLSDIEMPRMDGFDLARNIRGDAALRDLPIIMITSRIAQKHRDHAAQLGVNHYLGKPYSDEELMSLVRHYARLAAPMENA'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Ac_xyl_5818|HMPREF0005_03704|ZP_16402413.1',
					sequence_: 'MGVEKVDQVINLVGELVITQAMLAQTASTLDPVLHDRLLNGMEQLERNARDLQEAVMSIRMMPMDYVFSRFPRLVRDIAGKMGKQIELQTYGRATELDKSLIERIIDPLTHLVRNSLDHGIETPEKRVAAGKDPVGQLVLSAQHNGGNIVIEVSDDGAGLNREKILKKAMAQGLPVNENSPDDEIWQLIFAPGFSTAEKVTDISGRGVGMDVVRRNIQDMGGHVQLSCEPGNGTTTRIVLPLTLAILDGMSVRVGEETFILPLNHVTESLQPTNDQIYSVAGNERVMHVRGEYLPLVEMHRVFSVSDAQTDPTQAIAVIMQAEDRRFALLVDHLIGQHQVVVKNLESNYRKVPGISAATILGDGSVALIVDVFALARANRERWSQPEAILN'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Bu_cen_5788|I35_0298|ZP_16295615.1',
					sequence_: 'MITQAMLAETASAFDPALHDRLFNGMAQLERNARDLQEAVMSIRMMPMDYVFSRFPRLVRDLAGKLGKQVELVTFGQATELDKSLIERIIDPLTHLVRNSLDHGIETVDKRVAAGKDAVGQLVLSAAHHGGNIVIEVSDDGAGLNRERILAKAAKQGMQIAENISDDEVWQLIFAPGFSTAETVTDVSGRGVGMDVVKRNIQSMGGHVEITSLAGRGTTTRIVLPLTLAILDGMSVKVGSEIFILPLNFVMESLQPSNDDIYTVGNGERVVRVRGEYLPLVALHEVFSVEDARTDPTQGIVTIMETEGRRFAMLIDELVGQQQVVVKNLETNYRKVHGISAATILGDGSVALIVDVAALNRETRATHGARAGAELAVF'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Ru_gel_1696|RGE_37450|YP_005438583.1',
					sequence_: 'MDMDDALKTFFSEARELLADMETALLGADESPTAELDVNAIFRAAHTIKGSAGLFGLDGVVRFTHVLESVLDEVRAGSVAIRGPLLPLLLRCCDHVGAWVDALESGAEPGPAHRAVEDTLLVQLRAFLDAPAAAPEAAAAEPAPAAEGQWHLSIRFGADVLRNGMDPLAFVRYLSSIGRVERIVTLPDAVPTLEDLDPEGCCLGFEIALVTAADRATIESVFEFVIDDCELRLVPPRSRVAEYIDLIRALPEQPERIGEILVRCGSITERELVEALGVQREADPAPRLGALLAEQGRVAPEVVEAALDRQRQVRETRSSEASTIRVDAAKLDRLITLVGELVIAAAGARQAGRRVRDLELQEAHATLDALVQDVRDSALNLRMVRIGATFSRFKRVVHDVAHELGKDIELVVSGEDTELDKTVVEKLGDPLMHLVRNAIDHGIDSPEQRAARGKPARGVVGLNAFHDSGAIVIEVSDDGGGLNRERILAKARERGLVAPDQVPADHEIDQLIFEAGFSTAEKVTNLSGRGVGMDVVKQNITALRGSVALASRPGEGTTVTVRLPLTLAIINGFQVAVGRSMFVVPMEMVDECVAYSCADGHDYTDLRGGVLPLVRLRDLFGLGGVAPARQNIVVVQCGGARCGLVVDALLGESQTVIKPLSRMFQDVRGISGSALLGSGDVALILDVPAIAKLALARHASRAPSNDYDRQRLVATV'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Bu_pse_3464|BUH_6909|ZP_03791454.1',
					sequence_: 'MSTDDDFGRASLLELFREETHTQTQALSERLLALERGAQDAATLEACMRAAHSLKGAARIVGVPQGVDIAGRMEDCFVAAQHGRQPLTPCHVDALLTGVDLLVRVGDPQTAASVAPHEIDAFAAALAAADAGVEPGADARGANAYESDGNAHERGGAARASVAAAPGEAADASRESGAREAAGPNRAGAAAGAADVRASADAGDARGASDTRDVRRTAGARGANRSTEVFGAGEATGIGASTHANDANGMNATNLATSAAHPPRGAFAAAPDAPPSSAPSDAPRAPSQMRRVRADTLNRLLSLSGESLVESRWLKPFAESMLRVKRAQRDAARSLDSAVEALADDADPRVRGALNEARQMFTDLQRTFAARLDELDRFERRSSHIAEQLYDEALQCRMRPFGDATRAYPRVVRDLARSLGKRVRFSIVGEATQVDRDILDMLDAPLGHLLRNALDHGVEPPEVRLARGKPAEATITLEARHSAGSLLVSVSDDGPGADLAAVRAAIVRHHLTDEDTAARLSDQELLEFLLLPGFSMRERVTDVSGRGVGLDAVQEMVKSVRGAVRIFNEPGLGMRFVLQLPLTLSVIRSLIVDVGGEPYAFPLVQVRRTLELERADIDVLEGQQHFPLDDRRVGLVTAHQLLDAGELDESRPATAVVVVGGEPETYGVAVDRFLGERMLVVQPLDGRLNKIQNIAAGALLENGDPVLIVDVEDLIRSIDKLIRGGQLAKVRRGDRDALARRAKRVLVVDDSLTVRELERKLLEKRGYDVTIAIDGMDGWNAIRGDVFDLVVTDIDMPRMDGIELVTLIKGDPLLKSVPVMIVSYKDRDEDRRRGLEAGADYYLAKGGFHDEALLDAVHDLIGDA'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Me_ver_167|M301_1686|YP_003674643.1',
					sequence_: 'MTIDMSQFYEVFFDEAEELLAEAERLLLGIDIDSPDDEELNAIFRAAHSIKGGAATFGFMDMTEITHVLENLLDKIRKHEMALTAEHVDAFLAAKDVLKMEVDGHRLATAVDEEQVADVKMMLKQLSEAGAAVVKPAQATPAPVAAPVVTAPIVEAPKPADPVVVAAVPDDGLTRFNIVLPEVSEKDMSNLKDELGLLGDVESSQNENNRYVFKLTTDSTQADIISICSFVLDPDDLVITVSTAVSAPVVAQVEAKPAVVEDPGFGLFEDDVKATTASSSANEVKSSTSGVSIHEEVGYGLFAVDGKENVEEGYGFFAPFQPHKDAAVADLIGDDTVATEANSGKAELAKAEAVAVASKAAASEATDRRNQGRRESDKAPASAETSSIRVGIEKVDQLINLVGELVITQAMIEQRISQLDPVQHEPLINSVGQLTRNTRDLQESVMSIRMMPMDFVFSRFPRMVRDLAAKLGKKVEFVTVGATTELDKGLIERIVDPLTHLVRNSVDHGIETPEGRRAAGKSETGTLTLSAAHKGGSIVIEVTDDGAGLSRDKLLAKAAKNGLPVSESMSDTEVFNLIFAPGFSTAEVVTDVSGRGVGMDVVKRNITAMNGVVEIRSALGYGTTISIALPLTLAILDGMSVSLGNSIYVIPLNLIVETLQPRAEDIKTVTGEGRMVHVRGEYLPIIALHSLFNHHTDITDPTQGVLVLLESDGKKSALFVDRLVGQQQVVIKSLETNYRKVPGVSGATIMGDGGVALILDVSAIIQMGQTSNYLTGAPPFAHYQNAQSIEKNSNP'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Ga_cap_219|Galf_0984|YP_003846779.1',
					sequence_: 'MSDFACGVERIFDDFNAAMVAQNVARSSPDSESRSDQTNAAHARESVNWEALFTELTGTDIVTTVGATRDPEQIAEALSEEESTRKAFGRRTNDVPGATVGRRDGDVMVKEAKETTIRVDTERLDQVLNLSGEIGLTKNRLNHLRSDILQGRHDADTLRELDQSVTQLDMLVVNLQNAVMKTRMQPIGRLFKKYPRLARDLARSLGKDVELVLTGEETEMDKTMIEDLNDPLVHLVRNAVDHGVETVEGRIAAGKPEKSMVELSARHEGDHILITIADDGRGMRPEVIRGKAIEKGLLTSEVANTLDENQCLELIFLPGFSTKDEISSVSGRGVGMDVVKTNIQKLNGSINIDSIPGKGSVFTISLPLTLAILPVLILRLGDQSFAVPLSMVREILSVTPGQLQRISGRATMVVRGEVLPVLPLAQLIGWDASDKEPEVGVLMQFGNSSFILSADGFAGHDDVVIKSLDTFRPKGVAGVTMSSEGDIVLILDIKELLSDVRGN'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Ni_eut_687|Neut_1162|YP_747382.1',
					sequence_: 'MNTDTRINISSVMGIREAIEQIFTLIHRHFDSYATDTDDTRQIEECRYYMHQLNGMLEMLELSGVAFVGISVEELLAALQERRIEPDAQTLVVVRQAIRSIYRYLDALIDGEVDNPVKLFPVYRKIMQVQGLEEISESDLFFPDIRESLPLQPVELDLDDTSRQETAKQARAQFQSGLLSWLKNADDKQSLQKMIEAVRSIEKLPAAIEQRKFWWISSGFLDSLLHQEQVVDKSVRRLCGKIEQEIRHLNKESHVVAARLTRELLYRIARSQPVSERLQEISRVYDWQIPLSTIDNQEHLDESIMDEEATASDLQSMRVLLEDINDQWRKFNAEDQENISSLLALTEQLKVLISRVSCPPLEKLAGVIHGVLSYLRIRPQSMNEGIALDIASSLLLTENAIDNFHRLSPEFPSQVDALATRIRAVTTGKGEDIDLPDLPNPDQAGHLTQEKKLFKQVAQEVLANLAQVEDILDRFFFEPEIRNDLPLLPELFNQISGVLNVLELDQASTVLDSCRALTEKLTASDHLIDQAEQMLLADALSSLGFYIEALRNSQSDAEEILATIMQRLGQKPAGLGLSTDIREIPIDFAVAADRLFESDPEQLIDPELLAVFLDESSDVLASIADHLESCYANYANQDALTTIRRDFHTLKGSGRMVKLEALSEVAWRIEQLMNRWLSEQKPATSILLDLLAESHRQFSNWCASLRKDGAVEIKAEYLLDQIRALMYGTDEQPDIAATSLAPEVFEQAPEIEPLPTITDALSDIKTGAETAIRIGDSEVPADLFRIFINEASTHVATLKQAFNLPGDDAILSVTHESMLAAHTLASTSRALELGFIAQIGQALERWFNRLLTTSNMPGQQALSYMTTAVNLLDDMLATIREHQFPSAETVQASAEITHELMRLLEEAPAIQATETEQMVEMEEMAPLELAVDEVLEEDSSASMSETEISLPVSSLQQVKDAFADLDQELLEVFLEEAQELQSEIGTNLRIWRKQPNQMNARKAVLRALHTLKGSARIADAQQVSDLAHQMESDIESLYDQTASAALLDQLETQFDTISDKVEQLRSSLQPESQPAPVTEEAEAHPELLPPAVETVSALPISTADTDQPFRKTTLRVDAELIDRLINESGESSIIRSRVEAQLYDLEQYLQDLGESVDRMRGQLREVELLAETQMPASSLPSITGQTDFDPLELDRFTRFQELTRLMAESMDDVVTIHKSLREIQRAATMTVDQQAHLNRQLQQDLLRIRTIPFSHYSERLYRAVRQVTKDTGKQANLIIQGDSIEFDRGVLDKISSSLEHLLRNALVHGIETPEERLSIGKAEAGQITLDLHRDGNEIVMVLQDDGIGLDAERIREKARQLGLGSPENEQDDEQWYPLIFTHGFSTLDGVTDIAGRGVGLDIVRNELGELGGNIAVTSEKNRGTTFTLRFPVTLALTQALMVKAGDSTYAIPIAIVAHVLEMNAETLGTAYQEHHLIWNGNRFPLGYLPHLLGVSHTFPEIRRSNRIVLLQTEHEQLAIHADALIGQCEVVIKNIGPQLSNAPGIEGATITGDGSIVLIINPIKLLQREQVRELLSAGPMTPVDAADIHPSATAPVVMIVDDSLTVRKVTSRLLERQGYEILIAKDGVGALQLLRETIPAIMLVDIEMPHMDGFELIRAVRNNPELQNIPIIIISSRTAEKHRKVAEELGVNEFMGKPYQEDELLQHIERLIKEGC'
				},
				{
					isCircular_: false,
					isNormalized_: false,
					header_: 'Ru_gel_1696|RGE_39360|YP_005438771.1',
					sequence_: 'MADTQQEGAHLSAGIDLSQFFQVFFEEAGENLETMEQMLLNLDIENADDEELNAIFRCAHSVKGGAATFGFTDIAELTHEMETLLDKLRRHELAPTAAMVDVLLASGDALKAQLARHQGNGADPVDTRELLVSIRALVTGQAAAAPLAAAPAPTAAAPQPAAPSAAPSAAPAAGGTAARALELTVGPLPDPAMADNLVELFKEIADLGTIEPLDAGRDADGIRRFKVVTTTPDNDLLDLFTFHVAREQLKLGPLGPGYGFHEGAPGAPEPSKTEPDPGYGFFDDAPGAPQAGAAPAPAAAAEPARPAVAAPAAPARVAPKAEKAAASPESSTLRVSVEKVDQLINLVGELVITQAMLAQNSKGVDAALYQQMSSGLADLERNTRDLQEAVMSIRMIPMSLVFNRFPRMLRDLAAKLGKKVELVQVGEATELDKGLVEKITDPLTHLVRNSCDHGIELPEERLAKGKPETGTITLIASHQGGSIVIEVRDDGKGLNREKLLKKARERGLDAPDTMTDQEVYGLIFAPGFSTADVVTDVSGRGVGMDVVKKNITALGGTVEIDSAEGYGMTVRVRLPLTLAIMDGMSVGVGEECYILPLSSVVESFQVQPGMIKTIGGTGRVVEVRDEYMPVVDLERVFDVPRFDFERVSNIMVVVEAEGGRVALLVDELLGQQQVVVKNLESNYRKVDDVSGATIMGDGRVALILDIGSLVRRSRH'
				}
			]

			return fastaUtils.loadFasta(sampleFile).then(function(seqArray) {
				expect(seqArray).to.eql(expected)
			})
		})
	})
	describe('FilterSequences', function() {
		it('should have only one sequence if pass fasta_sample.10 and fasta_sample.9', function(done) {
			let sampleFile = './sampleData/fasta_sample.10.fa',
				refFile = './sampleData/fasta_sample.9.fa'

			fastaUtils.loadFasta(refFile).then(function(seqRef) {
				let reader = fs.createReadStream(sampleFile),
					parser = corebio.fastaStream(),
					filteredStream = new fastaUtils.FilterSequences(seqRef)

				let expected = [
					{
						isCircular_: false,
						isNormalized_: false,
						header_: 'Bu_pse_2959|BURPS305_6088|ZP_01764768.1',
						sequence_: 'MSTDDDFGRASLLELFREETHTQTQALSERLLALERGAQDAATLEACMRAAHSLKGAARIVGVPQGVDIAGRMEDCFVAAQHGRQPLTPCHVDALLTGVDLLVRVGDPQTAASVAPHEIDAFAAALAAADAGVEPGADARGANAYESDGNAHERGGAARASVAAAPGEAADASRESGAREAAGPNRAGAAAGAADVRASADAGDARGASDTRDVRHTAGARGANRSTEVFGAGEATGIGASTHANDANGMNATNLATSAAHPPRGAFAAAHDAPPSSAPSDAPRAPSQMRRVRADTLNRLLSLSGESLVESRWLKPFAESMLRVKRAQRDAARSLDSAVEALADDADPRVRGALNEARQMFTDLQRTFAARLDELDRFERRSSHIAEQLYDEALQCRMRPFGDATRAYPRVVRDLARSLGKRVRFSIVGEATQVDRDILDMLDAPLGHLLRNALDHGVEPPEVRLARGKPAEAAITLEARHSAGSLLVSVSDDGPGADLAAVRAAIVRHHLTDEDTAARLSDQELLEFLLLPGFSMRERVTDVSGRGVGLDAVQEMVKSVRGAVRIFNEPGLGMRFVLQLPLTLSVIRSLIVDVGGEPYAFPLVQVRRTLELERADIDVLEGQQHFPLDDRRVGLVTAHQLLDAGELDESRPATAVVVVGGEPETYGVAVDRFLGERMLVVQPLDGRLNKIQNIAAGALLENGDPVLIVDVEDLIRSIDKLIRGGQLAKVRRGDRDALARRAKRVLVVDDSLTVRELERKLLEKRGYDVTIAIDGMDGWNAIRGDAFDLVVTDIDMPRMDGIELVTLIKGDPLLKSVPVMIVSYKDRDEDRRRGLEAGADYYLAKGGFHDEALLDAVHDLIGDA'
					}
				]

				let results = []

				reader
					.pipe(parser)
					.pipe(filteredStream)
					.on('data', function(chunk, enc, d) {
						results.push(chunk)
					})
					.on('end', function() {
						expect(results).eql(expected)
						done()
					})
			})
		})
		it('should have two sequence if pass fasta_sample.10 and fasta_sample.8', function(done) {
			let sampleFile = './sampleData/fasta_sample.10.fa',
				refFile = './sampleData/fasta_sample.8.fa'

			fastaUtils.loadFasta(refFile).then(function(seqRef) {
				let reader = fs.createReadStream(sampleFile),
					parser = corebio.fastaStream(),
					filteredStream = new fastaUtils.FilterSequences(seqRef)

				let expected = [
					{
						isCircular_: false,
						isNormalized_: false,
						header_: 'Bu_pse_2959|BURPS305_6088|ZP_01764768.1',
						sequence_: 'MSTDDDFGRASLLELFREETHTQTQALSERLLALERGAQDAATLEACMRAAHSLKGAARIVGVPQGVDIAGRMEDCFVAAQHGRQPLTPCHVDALLTGVDLLVRVGDPQTAASVAPHEIDAFAAALAAADAGVEPGADARGANAYESDGNAHERGGAARASVAAAPGEAADASRESGAREAAGPNRAGAAAGAADVRASADAGDARGASDTRDVRHTAGARGANRSTEVFGAGEATGIGASTHANDANGMNATNLATSAAHPPRGAFAAAHDAPPSSAPSDAPRAPSQMRRVRADTLNRLLSLSGESLVESRWLKPFAESMLRVKRAQRDAARSLDSAVEALADDADPRVRGALNEARQMFTDLQRTFAARLDELDRFERRSSHIAEQLYDEALQCRMRPFGDATRAYPRVVRDLARSLGKRVRFSIVGEATQVDRDILDMLDAPLGHLLRNALDHGVEPPEVRLARGKPAEAAITLEARHSAGSLLVSVSDDGPGADLAAVRAAIVRHHLTDEDTAARLSDQELLEFLLLPGFSMRERVTDVSGRGVGLDAVQEMVKSVRGAVRIFNEPGLGMRFVLQLPLTLSVIRSLIVDVGGEPYAFPLVQVRRTLELERADIDVLEGQQHFPLDDRRVGLVTAHQLLDAGELDESRPATAVVVVGGEPETYGVAVDRFLGERMLVVQPLDGRLNKIQNIAAGALLENGDPVLIVDVEDLIRSIDKLIRGGQLAKVRRGDRDALARRAKRVLVVDDSLTVRELERKLLEKRGYDVTIAIDGMDGWNAIRGDAFDLVVTDIDMPRMDGIELVTLIKGDPLLKSVPVMIVSYKDRDEDRRRGLEAGADYYLAKGGFHDEALLDAVHDLIGDA'
					},
					{
						isCircular_: false,
						isNormalized_: false,
						header_: 'Me_ver_167|M301_1686|YP_003674643.1',
						sequence_: 'MTIDMSQFYEVFFDEAEELLAEAERLLLGIDIDSPDDEELNAIFRAAHSIKGGAATFGFMDMTEITHVLENLLDKIRKHEMALTAEHVDAFLAAKDVLKMEVDGHRLATAVDEEQVADVKMMLKQLSEAGAAVVKPAQATPAPVAAPVVTAPIVEAPKPADPVVVAAVPDDGLTRFNIVLPEVSEKDMSNLKDELGLLGDVESSQNENNRYVFKLTTDSTQADIISICSFVLDPDDLVITVSTAVSAPVVAQVEAKPAVVEDPGFGLFEDDVKATTASSSANEVKSSTSGVSIHEEVGYGLFAVDGKENVEEGYGFFAPFQPHKDAAVADLIGDDTVATEANSGKAELAKAEAVAVASKAAASEATDRRNQGRRESDKAPASAETSSIRVGIEKVDQLINLVGELVITQAMIEQRISQLDPVQHEPLINSVGQLTRNTRDLQESVMSIRMMPMDFVFSRFPRMVRDLAAKLGKKVEFVTVGATTELDKGLIERIVDPLTHLVRNSVDHGIETPEGRRAAGKSETGTLTLSAAHKGGSIVIEVTDDGAGLSRDKLLAKAAKNGLPVSESMSDTEVFNLIFAPGFSTAEVVTDVSGRGVGMDVVKRNITAMNGVVEIRSALGYGTTISIALPLTLAILDGMSVSLGNSIYVIPLNLIVETLQPRAEDIKTVTGEGRMVHVRGEYLPIIALHSLFNHHTDITDPTQGVLVLLESDGKKSALFVDRLVGQQQVVIKSLETNYRKVPGVSGATIMGDGGVALILDVSAIIQMGQTSNYLTGAPPFAHYQNAQSIEKNSNP'
					}
				]

				let results = []

				reader
					.pipe(parser)
					.pipe(filteredStream)
					.on('data', function(chunk, enc, d) {
						results.push(chunk)
					})
					.on('end', function() {
						expect(results).eql(expected)
						done()
					})
			})
		})
	})
})
